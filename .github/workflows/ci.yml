name: Re-Fit Backend CI

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]
    paths:
      - 'refit-backend/**'
  push:
    branches: [develop, main]
    paths:
      - 'refit-backend/**'
  workflow_dispatch:
    inputs:
      job_to_run:
        description: 'Which job to run'
        required: true
        type: choice
        options:
          - lint-and-test
          - integration
          - release-dev
          - release-prod
          - all

env:
  JAVA_VERSION: 21
  GRADLE_OPTS: -Dorg.gradle.jvmargs=-Xmx2048m -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

permissions:
  contents: write

jobs:
  # PR ê²€ì¦: ì»´íŒŒì¼ ì²´í¬
  # ëª©ì : ë¹ ë¥¸ í”¼ë“œë°±ì„ í†µí•œ ì½”ë“œ í’ˆì§ˆ ê²€ì¦
  lint-and-test:
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.job_to_run == 'lint-and-test')
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: refit-backend
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile Check
        run: ./gradlew compileJava --no-daemon

      - name: Build Check
        run: |
          set -e
          ./gradlew bootJar --no-daemon
          if [ ! -f "build/libs/refit-backend-0.0.1-SNAPSHOT.jar" ]; then
            echo "Error: JAR file not found"
            exit 1
          fi
          ls -lh build/libs/*.jar | head -1

  # í†µí•© ê²€ì¦: develop ë¸Œëžœì¹˜ ë¹Œë“œ ê²€ì¦ ë° ë³´ì•ˆ ìŠ¤ìº”
  # ëª©ì : develop ë¸Œëžœì¹˜ ë³‘í•© ì „ ë¹Œë“œ ê²€ì¦ ë° ë³´ì•ˆ ì·¨ì•½ì  í™•ì¸
  integration:
    if: |
      (github.event_name == 'push' && github.ref_name == 'develop') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.job_to_run == 'integration')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: refit-backend
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Security Scan
        run: |
          ./gradlew dependencies --no-daemon > dependencies.txt 2>&1 || true
          if grep -iE "(vulnerability|CVE|security|deprecated|unsafe)" dependencies.txt 2>/dev/null; then
            echo "Warning: Potential security issues detected"
            grep -iE "(vulnerability|CVE|security|deprecated|unsafe)" dependencies.txt | head -20
            echo "Please review dependencies.txt for details"
          else
            echo "No obvious security vulnerabilities detected"
          fi
        continue-on-error: true

  # ê°œë°œ í™˜ê²½ ë¦´ë¦¬ì¦ˆ (develop ë¸Œëžœì¹˜ - Docker ê¸°ë°˜)
  release-dev:
    needs: [integration]
    if: |
      always() &&
      needs.integration.result != 'failure' &&
      (
        (github.event_name == 'push' && github.ref_name == 'develop') ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'release-dev' || github.event.inputs.job_to_run == 'all'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        working-directory: refit-backend
        run: chmod +x gradlew

      - name: Build JAR (native amd64)
        working-directory: refit-backend
        run: ./gradlew clean bootJar -x test --no-daemon

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Image Metadata
        id: meta
        run: |
          SHA_SHORT="${GITHUB_SHA::7}"
          IMAGE_TAG="develop-${SHA_SHORT}"
          FULL_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${IMAGE_TAG}"
          LATEST_IMAGE="${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:develop-latest"

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "full_image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "latest_image=${LATEST_IMAGE}" >> $GITHUB_OUTPUT
          echo "sha_short=${SHA_SHORT}" >> $GITHUB_OUTPUT
          echo "ðŸ³ Docker Image: ${FULL_IMAGE}"

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: refit-backend
          push: true
          tags: |
            ${{ steps.meta.outputs.full_image }}
            ${{ steps.meta.outputs.latest_image }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/arm64

      - name: Trigger CD-Dev Workflow
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cd-dev.yml',
              ref: 'develop',
              inputs: {
                image_tag: '${{ steps.meta.outputs.image_tag }}',
                sha: '${{ github.sha }}',
                run_id: '${{ github.run_id }}'
              }
            });
            console.log('âœ… CD-Dev workflow triggered successfully');

  # ë¦´ë¦¬ì¦ˆ: main ë¸Œëžœì¹˜ í”„ë¡œë•ì…˜ ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ìƒì„±
  # ëª©ì : í”„ë¡œë•ì…˜ ë°°í¬ë¥¼ ìœ„í•œ ìµœì¢… ê²€ì¦ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
  release-prod:
    if: |
      (github.event_name == 'push' && github.ref_name == 'main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'release-prod' || github.event.inputs.job_to_run == 'all'))
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: production

    defaults:
      run:
        working-directory: refit-backend
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: ${{ github.event_name == 'push' && 0 || 1 }}
          token: ${{ secrets.PAT }}

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Inject Secret Configuration Files
        run: |
          mkdir -p src/main/resources
          if [ -z "${{ secrets.APPLICATION_SECRET_YML }}" ]; then
            echo "Error: APPLICATION_SECRET_YML secret not found"
            exit 1
          fi
          echo "${{ secrets.APPLICATION_SECRET_YML }}" > src/main/resources/application-secret.yml

      - name: Production Build
        run: ./gradlew clean bootJar --no-daemon

      - name: Verify JAR
        run: |
          set -e
          if [ ! -f "build/libs/refit-backend-0.0.1-SNAPSHOT.jar" ]; then
            echo "Error: JAR file not found"
            exit 1
          fi
          # JAR íŒŒì¼ ë¬´ê²°ì„± í™•ì¸
          if ! jar tf build/libs/refit-backend-0.0.1-SNAPSHOT.jar > /dev/null 2>&1; then
            echo "Error: Invalid JAR file"
            exit 1
          fi
          ls -lh build/libs/*.jar

      - name: Archive JAR Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar-${{ github.sha }}-${{ github.run_id }}
          path: refit-backend/build/libs/refit-backend-0.0.1-SNAPSHOT.jar
          retention-days: 7
          if-no-files-found: error
          compression-level: 6
      
      - name: Verify Artifact Upload
        if: success()
        run: |
          set -e
          echo "ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ê²€ì¦ ì¤‘..."
          JAR_FILE="build/libs/refit-backend-0.0.1-SNAPSHOT.jar"
          if [ ! -f "$JAR_FILE" ]; then
            echo "Error: JAR íŒŒì¼ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            exit 1
          fi
          FILE_SIZE=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null || echo "0")
          echo "ì—…ë¡œë“œëœ JAR íŒŒì¼ í¬ê¸°: ${FILE_SIZE} bytes"
          if [ "$FILE_SIZE" -lt 1000000 ]; then
            echo "Error: JAR íŒŒì¼ í¬ê¸°ê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ìž‘ìŠµë‹ˆë‹¤"
            exit 1
          fi
          echo "ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ê²€ì¦ ì™„ë£Œ"

      - name: Create Release Tag
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          TAG_NAME="v$(date +'%Y.%m.%d-%H%M%S')-${GITHUB_SHA::7}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          echo "Release tag created: $TAG_NAME"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

      - name: Trigger CD-Prod Workflow
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'cd-prod.yml',
              ref: 'main',
              inputs: {
                run_id: '${{ github.run_id }}',
                sha: '${{ github.sha }}',
                branch: 'main'
              }
            });
            console.log('âœ… CD-Prod workflow triggered successfully');