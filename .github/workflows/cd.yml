name: Re-Fit Backend CD

on:
  workflow_run:
    workflows: ["Re-Fit Backend CI"]
    types:
      - completed
    branches:
      - develop
      - main
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    environment:
      name: production

    steps:
      - name: Checkout code (workflow_run)
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Checkout code (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Download JAR Artifact (from CI)
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ github.event.workflow_run.head_sha }}
          path: build-output
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: false

      - name: Verify CI Artifact
        if: github.event_name == 'workflow_run'
        run: |
          echo "Verifying CI artifact..."
          echo "Artifact name: backend-jar-${{ github.event.workflow_run.head_sha }}"
          echo "Workflow run ID: ${{ github.event.workflow_run.id }}"
          
          if [ ! -f "build-output/refit-backend-0.0.1-SNAPSHOT.jar" ]; then
            echo "Error: CI artifact not found!"
            echo "CI should have uploaded the artifact. Please check:"
            echo "  1. CI integration/release job ran successfully"
            echo "  2. Artifact was uploaded with name: backend-jar-${{ github.event.workflow_run.head_sha }}"
            exit 1
          fi
          
          echo "CI artifact verified successfully"
          ls -lh build-output/*.jar

      - name: Set up JDK (for manual build)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        if: github.event_name == 'workflow_dispatch'
        working-directory: refit-backend
        run: chmod +x gradlew

      - name: Inject Secret Configuration Files (for manual build)
        if: github.event_name == 'workflow_dispatch'
        working-directory: refit-backend
        run: |
          mkdir -p src/main/resources
          
          if [ -n "${{ secrets.APPLICATION_SECRET_YML }}" ]; then
            echo "${{ secrets.APPLICATION_SECRET_YML }}" > src/main/resources/application-secret.yml
            echo "application-secret.yml injected successfully"
          else
            echo "Error: APPLICATION_SECRET_YML secret not found"
            exit 1
          fi

      - name: Build JAR (for manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        working-directory: refit-backend
        run: ./gradlew clean bootJar --no-daemon

      - name: Prepare JAR for deployment
        run: |
          set -e
          echo "Preparing JAR for deployment..."
          
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            if [ -f "build-output/refit-backend-0.0.1-SNAPSHOT.jar" ]; then
              echo "Using CI artifact"
            else
              echo "Error: CI artifact not found"
              exit 1
            fi
          else
            if [ -f "refit-backend/build/libs/refit-backend-0.0.1-SNAPSHOT.jar" ]; then
              echo "Using manually built artifact"
              mkdir -p build-output || {
                echo "Error: Failed to create build-output directory"
                exit 1
              }
              cp refit-backend/build/libs/refit-backend-0.0.1-SNAPSHOT.jar build-output/refit-backend-0.0.1-SNAPSHOT.jar || {
                echo "Error: Failed to copy JAR file"
                exit 1
              }
            else
              echo "Error: JAR file not found at refit-backend/build/libs/refit-backend-0.0.1-SNAPSHOT.jar"
              exit 1
            fi
          fi
          
          if [ ! -f "build-output/refit-backend-0.0.1-SNAPSHOT.jar" ]; then
            echo "Error: JAR file not found in build-output directory"
            exit 1
          fi
          
          echo "JAR file ready for deployment:"
          ls -lh build-output/refit-backend-0.0.1-SNAPSHOT.jar

      - name: Deploy JAR to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          source: "build-output/refit-backend-0.0.1-SNAPSHOT.jar"
          target: ${{ secrets.SERVER_BASE_PATH }}/app/backend/refit-backend/build/libs/
          strip_components: 1

      - name: Deploy and restart backend
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -e
            
            BASE_PATH="${{ secrets.SERVER_BASE_PATH }}"
            JAR_PATH="$BASE_PATH/app/backend/refit-backend/build/libs/refit-backend-0.0.1-SNAPSHOT.jar"
            BACKUP_DIR="$BASE_PATH/backups/backend"
            APP_NAME="backend"
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            
            echo "============================================"
            echo "Re-Fit BE 배포 시작: $(date)"
            echo "============================================"
            
            # 백업 디렉토리 준비
            mkdir -p $BACKUP_DIR || {
                echo "에러: 백업 디렉토리 생성 실패: $BACKUP_DIR"
                exit 1
            }
            
            # JAR 파일 존재 확인
            if [ ! -f "$JAR_PATH" ]; then
                echo "에러: JAR 파일을 찾을 수 없습니다: $JAR_PATH"
                exit 1
            fi
            
            # 백업 (롤백용)
            cp "$JAR_PATH" "$BACKUP_DIR/backend-$TIMESTAMP.jar" || {
                echo "에러: 백업 파일 복사 실패"
                exit 1
            }
            echo "백업 완료: $BACKUP_DIR/backend-$TIMESTAMP.jar"
            
            # 권한 확인 및 수정
            sudo chown -R ubuntu:ubuntu "$(dirname "$JAR_PATH")" 2>/dev/null || true
            
            # PM2를 이용한 무중단 재시작
            if pm2 describe $APP_NAME > /dev/null 2>&1; then
                echo "기존 프로세스 교체 (Delete + Start)..."
                pm2 delete $APP_NAME || true
            else
                echo "신규 프로세스 시작..."
            fi
            
            # PM2 시작 및 상태 확인
            pm2 start /usr/bin/java --name "$APP_NAME" -- -jar "$JAR_PATH" || {
                echo "에러: PM2 start 명령어 실행 실패"
                exit 1
            }
            
            # PM2 시작 확인
            sleep 2
            if ! pm2 describe $APP_NAME > /dev/null 2>&1; then
                echo "에러: PM2 프로세스 시작 실패"
                pm2 logs $APP_NAME --lines 20 --nostream || true
                exit 1
            fi
            
            # Caddy 리로드
            if systemctl is-active --quiet caddy; then
                sudo systemctl reload caddy || {
                    echo "경고: Caddy 리로드 실패 (계속 진행)"
                }
            else
                echo "경고: Caddy 서비스가 실행 중이 아닙니다"
            fi
            
            # 배포 검증
            echo "배포 검증 중 (초기 10초 대기)..."
            sleep 10
            
            MAX_RETRIES=3
            RETRY_INTERVAL=5
            HTTP_STATUS="000"
            
            for i in $(seq 1 $MAX_RETRIES); do
                echo "Checking backend health endpoint (시도 $i/$MAX_RETRIES)..."
                HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health 2>/dev/null || echo "000")
                echo "HTTP Status Code: $HTTP_STATUS"
                
                if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "404" ]; then
                    echo "배포 성공! (HTTP $HTTP_STATUS)"
                    pm2 save
                    
                    # 오래된 백업 삭제 (7일 이상)
                    find $BACKUP_DIR -name "backend-*.jar" -type f -mtime +7 -delete 2>/dev/null || true
                    break
                fi
                
                if [ $i -lt $MAX_RETRIES ]; then
                    echo "헬스 체크 실패, ${RETRY_INTERVAL}초 후 재시도..."
                    sleep $RETRY_INTERVAL
                fi
            done
            
            if [ "$HTTP_STATUS" != "200" ] && [ "$HTTP_STATUS" != "404" ]; then
                echo "배포 이상 감지! (HTTP $HTTP_STATUS)"
                echo "PM2 상태 확인:"
                pm2 status
                echo "백엔드 로그 (최근 50줄):"
                pm2 logs $APP_NAME --lines 50 --nostream || true
                echo "롤백이 필요한 경우: cp $BACKUP_DIR/backend-$TIMESTAMP.jar $JAR_PATH && pm2 restart $APP_NAME"
                exit 1
            fi
            
            echo "============================================"
            echo "Re-Fit BE 배포 완료: $(date)"
            echo "============================================"
